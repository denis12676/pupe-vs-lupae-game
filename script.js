// –ò–≥—Ä–æ–≤–æ–π –¥–≤–∏–∂–æ–∫
class PupeLupaeGame {
    constructor() {
        this.currentScreen = 'welcome';
        this.gameActive = false;
        this.gameDuration = 10000; // 10 —Å–µ–∫—É–Ω–¥
        this.timer = null;
        this.techTimer = null;
        this.money = 0;
        this.correctMoves = 0;
        this.wrongMoves = 0;
        this.premiumCount = 0;
        this.lastTapTime = 0;
        this.comboWindow = 300; // –æ–∫–Ω–æ –¥–ª—è –∫–æ–º–±–æ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        
        // –°–ø–∏—Å–∫–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
        this.frontendTechs = [
            'React', 'Vue.js', 'Angular', 
            'CSS', 'HTML', 'JavaScript', 
            'TypeScript', 'SASS', 'JSX',
            'Bootstrap', 'Tailwind', 'Webpack'
        ];
        
        this.backendTechs = [
            'Node.js', 'Django', 'Express.js', 
            'Python', 'PostgreSQL', 'MongoDB', 
            'Ruby on Rails', 'ASP.NET', 'MySQL',
            'Redis', 'GraphQL', 'Docker'
        ];
        
        // –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∞–∫—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        this.pupeReactions = [
            "–£—Ä–∞! –ï—â—ë –æ–¥–∏–Ω CSS-–º–∞—Å—Ç–µ—Ä! üíÖ",
            "React forever! ‚öõÔ∏è",
            "–ù–∞—á–∏–Ω–∞–µ–º –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ TypeScript! üìù",
            "–ì–ª–∞–≤–Ω–æ–µ —Ç–µ–Ω–∏ –∫—Ä–∞—Å–∏–≤—ã–µ! ‚ú®",
            "Flexbox ‚Äî –º–æ—è —Å–∏–ª–∞! üí™"
        ];
        
        this.lupaeReactions = [
            "–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö ‚Äî –º–æ—è —Å—Ç–∏—Ö–∏—è! üóÑÔ∏è",
            "–°–µ—Ä–≤–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –±—ã—Å—Ç—Ä—ã–º–∏! ‚ö°",
            "Python ‚Äî —ç—Ç–æ —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ—Å—Ç—å! üêç",
            "API –∫–∞–∫ —á–∞—Å—ã! ‚è∞",
            "–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º –º–∞–≥–∏—è! ü™Ñ"
        ];
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.setupThemeToggle();
        this.showWelcomeScreen();
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
        setTimeout(() => {
            document.querySelector('.game-title').classList.add('animate-bounce-in');
            document.querySelector('.character-preview').style.opacity = '0';
            setTimeout(() => {
                document.querySelector('.character-preview').style.opacity = '1';
            }, 200);
        }, 100);
    }
    
    setupEventListeners() {
        // –ö–Ω–æ–ø–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
        document.getElementById('start-game-btn').addEventListener('click', () => {
            this.startGame();
        });
        
        // –ò–≥—Ä–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏
        document.getElementById('pupe-btn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.handleTap('pupe');
        });
        
        document.getElementById('pupe-btn').addEventListener('click', (e) => {
            e.preventDefault();
            this.handleTap('pupe');
        });
        
        document.getElementById('lupae-btn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            this.handleTap('lupae');
        });
        
        document.getElementById('lupae-btn').addEventListener('click', (e) => {
            e.preventDefault();
            this.handleTap('lupae');
        });
        
        // –ö–Ω–æ–ø–∫–∞ —Å–Ω–æ–≤–∞ –∏–≥—Ä–∞—Ç—å
        document.getElementById('play-again-btn').addEventListener('click', () => {
            this.showWelcomeScreen();
        });
        
        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        this.setupMobileOptimization();
    }
    
    setupMobileOptimization() {
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑—É–º–∞ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        this.vibrateSupported = 'vibrate' in navigator;
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞—Å–∞–Ω–∏–π
        document.addEventListener('touchstart', (e) => {
            if (this.gameActive) {
                e.target.classList.add('touching');
            }
        }, true);
        
        document.addEventListener('touchend', (e) => {
            e.target.classList.remove('touching');
        }, true);
    }
    
    setupThemeToggle() {
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É –∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.setAttribute('data-theme', savedTheme);
        themeToggle.textContentElement = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', newTheme);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–Ω—Ç–∞–∂–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—Ä–µ—Ö–æ–¥–∞
            document.body.style.background = newTheme === 'dark' ? 'linear-gradient(180deg, #000 0%, #1a1a2e 100%)' : 'linear-gradient(180deg, #667eea 0%, #764ba2 100%)';
            
            setTimeout(() => {
                document.body.style.background = '';
            }, 500);
        });
    }
    
    showWelcomeScreen() {
        this.hideAllScreens();
        this.currentScreen = 'welcome';
        
        // –°–±—Ä–æ—Å –∏–≥—Ä—ã
        this.gameActive = false;
        this.money = 0;
        this.correctMoves = 0;
        this.wrongMoves = 0;
        this.premiumCount = 0;
        
        document.getElementById('welcome-screen').classList.remove('hidden');
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        this.addRandomCharacterAnimations();
    }
    
    showGameScreen() {
        this.hideAllScreens();
        this.currentScreen = 'game';
        document.getElementById('game-screen').classList.remove('hidden');
        
        // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∫–∞–∑ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
        this.startTechCycle();
        this.startGameTimer();
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        setTimeout(() => {
            document.querySelector('.game-buttons').style.transform = 'translateY(100px)';
            document.querySelector('.game-buttons').style.opacity = '0';
            setTimeout(() => {
                document.querySelector('.game-buttons').style.transition = 'all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)';
                document.querySelector('.game-buttons').style.transform = 'translateY(0)';
                document.querySelector('.game-buttons').style.opacity = '1';
            }, 200);
        }, 100);
    }
    
    showResultScreen() {
        this.hideAllScreens();
        this.currentScreen = 'result';
        
        document.getElementById('result-screen').classList.remove('hidden');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        document.getElementById('final-money').textContent = this.money;
        document.getElementById('correct-moves').textContent = this.correctMoves;
        document.getElementById('wrong-moves').textContent = this.wrongMoves;
        document.getElementById('premium-count').textContent = this.premiumCount);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        let status = '';
        if (this.money >= 15) status = 'üåü –ù–µ–≤–µ—Ä–æ—è—Ç–Ω–æ! –í—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –º–∞–≥!';
        else if (this.money >= 10) status = 'üíØ –û—Ç–ª–∏—á–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è!';
        else if (this.money >= 5) status = 'üëç –ù–µ–ø–ª–æ—Ö–æ —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å!';
        else if (this.money >= 2) status = 'ü§î –ï—â–µ –µ—Å—Ç—å –º–µ—Å—Ç–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è';
        else status = 'üòÖ –ë—ã–≤–∞–µ—Ç —Ç–∞–∫–æ–µ... –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!';
        
        document.getElementById('score-status').textContent = status;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª—É—á—à–µ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
        const bestScore = parseInt(localStorage.getItem('bestScore')) || 0;
        if (this.money > bestScore) {
            localStorage.setItem('bestScore', this.money.toString());
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
            setTimeout(() => {
                this.showAchievement('üéâ –ù–æ–≤—ã–π —Ä–µ–∫–æ—Ä–¥!', `–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ ${this.money} –¥–µ–Ω–µ–≥!`);
            }, 1000);
        }
    }
    
    hideAllScreens() {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.add('hidden');
        });
    }
    
    startGame() {
        this.gameActive = true;
        this.showGameScreen();
        
        // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
        document.body.style.backgroundColor = '#1a1a2e';
        setTimeout(() => {
            document.body.style.backgroundColor = '';
        }, 500);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        setTimeout(() => {
            document.getElementById('instruction-text').textContent = '–ì–æ—Ç–æ–≤—ã? –ü—É–ø–∞ –ø—Ä–æ—Ç–∏–≤ –õ—É–ø—ã –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è! ‚ö°';
        }, 500);
        
        setTimeout(() => {
            document.getElementById('instruction-text').textContent = '–¢–∞–ø–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏!';
        }, 2000);
    }
    
    startTechCycle() {
        let techInterval = () => {
            if (!this.gameActive) return;
            
            const techType = Math.random();
            let tech, techCategory;
            
            if (techType < 0.6) {
                // –§—Ä–æ–Ω—Ç–µ–Ω–¥ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è (60% —à–∞–Ω—Å)
                tech = this.getRandomTech('frontend');
                techCategory = 'frontend';
            } else if (techType < 0.95) {
                // –ë—ç–∫–µ–Ω–¥ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è (35% —à–∞–Ω—Å)
                tech = this.getRandomTech('backend');
                techCategory = 'backend';
            } else {
                // –ü—Ä–µ–º–∏—è (5% —à–∞–Ω—Å)
                tech = '–ü—Ä–µ–º–∏—è';
                techCategory = 'premium';
            }
            
            this.displayTech(tech, techCategory);
            
            // –°–ª—É—á–∞–π–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏ (650ms - 1200ms)
            const nextInterval = 650 + Math.random() * 550;
            setTimeout(techInterval, nextInterval);
        };
        
        // –ü–µ—Ä–≤–∞—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(techInterval, 800);
    }
    
    getRandomTech(type) {
        const techs = type === 'frontend' ? this.frontendTechs : this.backendTechs;
        return techs[Math.floor(Math.random() * techs.length)];
    }
    
    displayTech(tech, category) {
        const badge = document.getElementById('technology-badge');
        const techElement = document.getElementById('current-tech');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
        techElement.textContent = tech;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∑–Ω–∞—á–∫–∞
        badge.className = `technology-badge ${category}`;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
